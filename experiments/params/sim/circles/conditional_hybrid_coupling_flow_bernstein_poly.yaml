compile_kwargs:
  jit_compile: true
two_stage_training: true
fit_kwargs:
- epochs: 200
  batch_size: 512
  learning_rate: 0.005
  reduce_lr_on_plateau: false
  early_stopping: 30
  monitor: val_loss
  verbose: true
  validation_split: 0.25
- epochs: &epochs 200
  batch_size: 512
  learning_rate:
    scheduler_kwargs:
      decay_steps: *epochs
      initial_learning_rate: 0.005
    scheduler_name: cosine_decay
  reduce_lr_on_plateau: false
  early_stopping: 30
  monitor: val_loss
  verbose: true
  validation_split: 0.25
model_kwargs:
  marginal_bijectors:
  - bijector: BernsteinPolynomial
    invert: true
    bijector_kwargs:
      domain: [0, 1]
      extrapolation: false
    parameters_constraint_fn: mctm.activations.get_thetas_constrain_fn
    parameters_constraint_fn_kwargs:
      allow_flexible_bounds: false
      bounds: linear
      high: 5
      low: -5
    parameters_fn: parameter_vector
    parameters_fn_kwargs:
      dtype: float32
      parameter_shape: [&dims 2, 500]
    # parameters_fn: fully_connected_network
    # parameters_fn_kwargs:
    #   activation: relu
    #   batch_norm: false
    #   dropout: false
    #   hidden_units:
    #   - 512
    #   - 512
    #   - 512
    # parameters_fn: fully_connected_res_net
    # parameters_fn_kwargs:
    #   activation: relu
    #   batch_norm: false
    #   dropout: false # 0.2
    #   res_blocks: 2
    #   hidden_features: 512
      # dtype: float32
      # input_shape: [1]
      # parameter_shape: [2, 300]
      # conditional: true
      # conditional_event_shape: 1

  - bijector: Scale
    parameters_constraint_fn: tf.math.softplus
    parameters_fn: bernstein_polynomial
    parameters_fn_kwargs:
      conditional_event_shape: 1
      dtype: float
      extrapolation: true
      parameter_shape: [*dims]
      polynomial_order: 1
  joint_bijectors:
  - bijector: RealNVP
    bijector_kwargs:
      num_masked: 1
    nested_bijector:
    # - bijector: Scale
    #   invert: true
    #   parametrized_by_parent: true
    #   parameters_constraint_fn: tf.math.softplus
    #   parameters_slice_size: 1
    # - bijector: Shift
    #   invert: true
    #   parametrized_by_parent: true
    #   parameters_slice_size: 1
      bijector: BernsteinPolynomial
      invert: true
      bijector_kwargs:
        domain: [-5, 5]
        extrapolation: false
      parameters_constraint_fn: mctm.activations.get_thetas_constrain_fn
      parameters_constraint_fn_kwargs:
        allow_flexible_bounds: false
        bounds: linear
        high: 5
        low: -5
      parametrized_by_parent: true
      parameters_slice_size: 300
    # parameters_fn: bernstein_polynomial
    # parameters_fn_kwargs:
    #   conditional_event_shape: 1
    #   dtype: float
    #   extrapolation: true
    #   parameter_shape: [1, 100]
    #   polynomial_order: 300
    #   conditional: false
    #   domain: [-5, 5]
    parameters_fn: fully_connected_network
    parameters_fn_kwargs:
      activation: relu
      batch_norm: false
      dropout: false
      hidden_units:
      - 512
      - 512
      - 512
    # parameters_fn: fully_connected_res_net
    # parameters_fn_kwargs:
    #   activation: relu
    #   batch_norm: false
    #   dropout: false # 0.2
    #   res_blocks: 2
    #   hidden_features: 512
      dtype: float32
      input_shape: [1]
      parameter_shape: [1, 300]
      # conditional: true
      # conditional_event_shape: 1
